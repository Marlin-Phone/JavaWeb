# 实验四  会话管理

## 一、实验目的
1. 了解Web服务器对客户会话跟踪的各种方法；
2. 重点掌握使用HttpSession对象跟踪会话的方法；
3. 掌握使用Cookie技术跟踪会话的方法；
4. 了解URL重写和隐藏表单域的方法。

## 二、实验要求
1. 实验前进行预习，完成实验预习报告；
2. 按照每一项实验内容进行上机实践与编程，将程序源代码和运行结果图附在实验报告中实验内容对应的部分。
3. 实验预习报告和实验报告打印装订在一起。
4. 将每一次实验的源代码按目录组织保存并压缩，按照老师指定的要求进行提交。代码保存方式如：exp04表示实验四的Web项目的名称，其下保存各项实验内容的源文件及相关资源，将整个exp04文件夹进行压缩后命名为班级-姓名-实验04，如计171-张三-实验04。

## 三、实验内容与步骤

### 1. 使用HttpSession对象管理会话

#### 实验步骤：
创建一个名为ShowSessionInfo的Servlet，显示当前客户的会话ID、会话创建时间、最近一次访问会话的时间、该客户访问会话次数等信息。

#### ShowSessionInfo.java源代码：
```java
package com.servlet;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.*;
import java.util.Date;

@WebServlet("/showSessionInfo")
public class ShowSessionInfo extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        // 获取会话对象，如果不存在则创建
        HttpSession session = request.getSession(true);
        
        // 获取会话ID
        String sessionId = session.getId();
        
        // 获取会话创建时间
        long creationTime = session.getCreationTime();
        Date creationDate = new Date(creationTime);
        
        // 获取最近访问时间
        long lastAccessTime = session.getLastAccessedTime();
        Date lastAccessDate = new Date(lastAccessTime);
        
        // 获取访问次数（自定义属性）
        Integer accessCount = (Integer) session.getAttribute("accessCount");
        if (accessCount == null) {
            accessCount = 1;
        } else {
            accessCount = accessCount + 1;
        }
        session.setAttribute("accessCount", accessCount);
        
        out.println("<html><head><title>会话信息</title></head><body>");
        out.println("<h2>会话信息</h2>");
        out.println("<p><strong>会话ID：</strong>" + sessionId + "</p>");
        out.println("<p><strong>会话创建时间：</strong>" + creationDate.toString() + "</p>");
        out.println("<p><strong>最近访问时间：</strong>" + lastAccessDate.toString() + "</p>");
        out.println("<p><strong>访问次数：</strong>" + accessCount + "</p>");
        out.println("<p><a href='showSessionInfo'>刷新页面</a></p>");
        out.println("</body></html>");
    }
}
```

### 2. 使用HttpSession会话对象设计猜数游戏

#### 实验步骤：
设计一个GuessNumberServlet.java，实现简单的猜数游戏。

#### GuessNumberServlet.java源代码：
```java
package com.servlet;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.*;
import java.util.Random;

@WebServlet("/guessNumber")
public class GuessNumberServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        HttpSession session = request.getSession(true);
        
        // 显示会话信息
        out.println("<html><head><title>猜数游戏</title></head><body>");
        out.println("<h2>猜数游戏</h2>");
        out.println("<p><strong>会话ID：</strong>" + session.getId() + "</p>");
        
        // 生成1-100的随机数并保存到session中
        Integer randomNumber = (Integer) session.getAttribute("randomNumber");
        if (randomNumber == null) {
            randomNumber = new Random().nextInt(100) + 1;
            session.setAttribute("randomNumber", randomNumber);
            out.println("<p>我已经想好了一个1到100之间的数字，请你猜猜是多少？</p>");
        } else {
            out.println("<p>继续猜数游戏</p>");
        }
        
        // 显示猜数表单
        out.println("<form method='post' action='guessNumber'>");
        out.println("<label>请输入你猜的数字：</label>");
        out.println("<input type='number' name='guess' min='1' max='100' required>");
        out.println("<input type='submit' value='提交'>");
        out.println("</form>");
        
        out.println("</body></html>");
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        HttpSession session = request.getSession(true);
        
        // 获取用户输入的数字
        String guessStr = request.getParameter("guess");
        int guess = Integer.parseInt(guessStr);
        
        // 获取session中的随机数
        Integer randomNumber = (Integer) session.getAttribute("randomNumber");
        
        out.println("<html><head><title>猜数游戏结果</title></head><body>");
        out.println("<h2>猜数游戏结果</h2>");
        
        if (guess == randomNumber) {
            // 猜对了
            out.println("<p style='color:green;'>恭喜你，猜对了！数字就是 " + randomNumber + "</p>");
            out.println("<p>游戏结束，会话已终止。</p>");
            
            // 强制结束会话
            session.invalidate();
            
            // 提供重新开始游戏的链接
            out.println("<p><a href='guessNumber'>重新开始游戏</a></p>");
        } else {
            // 猜错了
            if (guess > randomNumber) {
                out.println("<p style='color:red;'>你猜的数字太大了！</p>");
            } else {
                out.println("<p style='color:red;'>你猜的数字太小了！</p>");
            }
            
            // 显示继续猜数的表单
            out.println("<form method='post' action='guessNumber'>");
            out.println("<label>请再猜一次：</label>");
            out.println("<input type='number' name='guess' min='1' max='100' required>");
            out.println("<input type='submit' value='提交'>");
            out.println("</form>");
        }
        
        out.println("</body></html>");
    }
}
```

### 3. 使用Cookie实现自动登录功能

#### 实验步骤：
编写一个CheckUserServlet，通过Cookie实现自动登录的功能。

#### CheckUserServlet.java源代码：
```java
package com.servlet;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.*;

@WebServlet("/checkUser")
public class CheckUserServlet extends HttpServlet {
    // 模拟用户数据库
    private static final String VALID_USERNAME = "admin";
    private static final String VALID_PASSWORD = "123456";
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        // 检查Cookie中是否包含登录信息
        String savedUsername = null;
        String savedPassword = null;
        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if ("username".equals(cookie.getName())) {
                    savedUsername = cookie.getValue();
                } else if ("password".equals(cookie.getName())) {
                    savedPassword = cookie.getValue();
                }
            }
        }
        
        // 验证Cookie中的登录信息
        if (savedUsername != null && savedPassword != null && 
            VALID_USERNAME.equals(savedUsername) && VALID_PASSWORD.equals(savedPassword)) {
            // 自动登录成功
            out.println("<html><head><title>自动登录成功</title></head><body>");
            out.println("<h2>欢迎回来，" + savedUsername + "！</h2>");
            out.println("<p>您已通过Cookie自动登录。</p>");
            out.println("<p><a href='checkUser'>刷新页面</a> | <a href='logout'>退出登录</a></p>");
            out.println("</body></html>");
        } else {
            // 显示登录表单
            showLoginForm(out, false);
        }
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        // 获取用户输入的用户名和密码
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        String autoLogin = request.getParameter("autoLogin");
        
        // 验证用户名和密码
        if (VALID_USERNAME.equals(username) && VALID_PASSWORD.equals(password)) {
            // 登录成功
            out.println("<html><head><title>登录成功</title></head><body>");
            out.println("<h2>登录成功！</h2>");
            out.println("<p>欢迎，" + username + "！</p>");
            
            // 如果用户选择了自动登录，发送Cookie
            if ("on".equals(autoLogin)) {
                Cookie usernameCookie = new Cookie("username", username);
                Cookie passwordCookie = new Cookie("password", password);
                
                // 设置Cookie的有效期为7天
                usernameCookie.setMaxAge(7 * 24 * 60 * 60);
                passwordCookie.setMaxAge(7 * 24 * 60 * 60);
                
                // 添加Cookie到响应中
                response.addCookie(usernameCookie);
                response.addCookie(passwordCookie);
                
                out.println("<p>已设置自动登录Cookie，有效期7天。</p>");
            }
            
            out.println("<p><a href='checkUser'>访问主页</a> | <a href='logout'>退出登录</a></p>");
            out.println("</body></html>");
        } else {
            // 登录失败
            out.println("<html><head><title>登录失败</title></head><body>");
            out.println("<h2 style='color:red;'>登录失败！</h2>");
            out.println("<p>用户名或密码错误。</p>");
            showLoginForm(out, true);
            out.println("</body></html>");
        }
    }
    
    // 显示登录表单
    private void showLoginForm(PrintWriter out, boolean showError) {
        if (showError) {
            out.println("<p style='color:red;'>登录失败，请重新输入用户名和密码。</p>");
        }
        
        out.println("<h2>用户登录</h2>");
        out.println("<form method='post' action='checkUser'>");
        out.println("<table>");
        out.println("<tr><td>用户名：</td><td><input type='text' name='username' required></td></tr>");
        out.println("<tr><td>密码：</td><td><input type='password' name='password' required></td></tr>");
        out.println("<tr><td colspan='2'><input type='checkbox' name='autoLogin'> 记住我（自动登录）</td></tr>");
        out.println("<tr><td colspan='2'><input type='submit' value='登录'> <input type='reset' value='重置'></td></tr>");
        out.println("</table>");
        out.println("</form>");
    }
}
```

#### LogoutServlet.java源代码（用于退出登录）：
```java
package com.servlet;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.*;

@WebServlet("/logout")
public class LogoutServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        // 获取会话并销毁
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.invalidate();
        }
        
        // 删除Cookie
        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if ("username".equals(cookie.getName()) || "password".equals(cookie.getName())) {
                    cookie.setMaxAge(0); // 删除Cookie
                    response.addCookie(cookie);
                }
            }
        }
        
        out.println("<html><head><title>退出登录</title></head><body>");
        out.println("<h2>您已成功退出登录</h2>");
        out.println("<p><a href='checkUser'>重新登录</a></p>");
        out.println("</body></html>");
    }
}
```

### 4. URL重写示例

#### 实验步骤：
编写HomeServlet.java，对通过超链接请求的两个URL进行重写。

#### HomeServlet.java源代码：
```java
package com.servlet;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.*;

@WebServlet("/home")
public class HomeServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        // 获取会话对象
        HttpSession session = request.getSession(true);
        
        out.println("<html><head><title>主页</title></head><body>");
        out.println("<h2>主页</h2>");
        out.println("<p>会话ID: " + session.getId() + "</p>");
        
        // 使用URL重写生成链接
        String page1Url = response.encodeURL("page1");
        String page2Url = response.encodeURL("page2");
        
        out.println("<p><a href='" + page1Url + "'>页面1</a></p>");
        out.println("<p><a href='" + page2Url + "'>页面2</a></p>");
        out.println("</body></html>");
    }
}

@WebServlet("/page1")
class Page1Servlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        HttpSession session = request.getSession(false);
        
        out.println("<html><head><title>页面1</title></head><body>");
        out.println("<h2>页面1</h2>");
        if (session != null) {
            out.println("<p>会话ID: " + session.getId() + "</p>");
        } else {
            out.println("<p>没有会话</p>");
        }
        out.println("<p><a href='" + response.encodeURL("home") + "'>返回主页</a></p>");
        out.println("</body></html>");
    }
}

@WebServlet("/page2")
class Page2Servlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        HttpSession session = request.getSession(false);
        
        out.println("<html><head><title>页面2</title></head><body>");
        out.println("<h2>页面2</h2>");
        if (session != null) {
            out.println("<p>会话ID: " + session.getId() + "</p>");
        } else {
            out.println("<p>没有会话</p>");
        }
        out.println("<p><a href='" + response.encodeURL("home") + "'>返回主页</a></p>");
        out.println("</body></html>");
    }
}
```

### 5. 购物车程序的改进

#### 实验步骤：
根据给定的购物车程序，做如下补充和改进。

#### ShoppingCart.java源代码：
```java
package com.cart;

import java.util.*;

public class ShoppingCart {
    private List<GoodsItem> items = new ArrayList<>();
    
    // 添加商品
    public void add(GoodsItem item) {
        // 检查购物车中是否已存在该商品
        for (GoodsItem existingItem : items) {
            if (existingItem.getId() == item.getId()) {
                // 如果存在，增加数量
                existingItem.setQuantity(existingItem.getQuantity() + item.getQuantity());
                return;
            }
        }
        // 如果不存在，添加新商品
        items.add(item);
    }
    
    // 更新商品数量
    public void update(GoodsItem item) {
        for (GoodsItem existingItem : items) {
            if (existingItem.getId() == item.getId()) {
                // 更新商品数量
                existingItem.setQuantity(item.getQuantity());
                return;
            }
        }
    }
    
    // 删除商品
    public void remove(int id) {
        items.removeIf(item -> item.getId() == id);
    }
    
    // 获取所有商品
    public List<GoodsItem> getItems() {
        return items;
    }
    
    // 计算总金额
    public double getTotal() {
        return items.stream().mapToDouble(item -> item.getPrice() * item.getQuantity()).sum();
    }
}
```

#### GoodsItem.java源代码：
```java
package com.cart;

public class GoodsItem {
    private int id;
    private String name;
    private double price;
    private int quantity;
    
    public GoodsItem() {}
    
    public GoodsItem(int id, String name, double price, int quantity) {
        this.id = id;
        this.name = name;
        this.price = price;
        this.quantity = quantity;
    }
    
    // getter和setter方法
    public int getId() { return id; }
    public void setId(int id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public double getPrice() { return price; }
    public void setPrice(double price) { this.price = price; }
    
    public int getQuantity() { return quantity; }
    public void setQuantity(int quantity) { this.quantity = quantity; }
}
```

#### showCart.jsp源代码：
```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ page import="com.cart.ShoppingCart, com.cart.GoodsItem, java.util.List" %>
<%
    ShoppingCart cart = (ShoppingCart) session.getAttribute("cart");
    if (cart == null) {
        cart = new ShoppingCart();
        session.setAttribute("cart", cart);
    }
%>
<html>
<head>
    <title>购物车</title>
</head>
<body>
<h2>购物车</h2>
<%
    List<GoodsItem> items = cart.getItems();
    if (items.isEmpty()) {
%>
<p>购物车为空</p>
<%
    } else {
%>
<form method="post" action="controller">
<table border="1">
    <tr>
        <th>商品名称</th>
        <th>单价</th>
        <th>数量</th>
        <th>小计</th>
        <th>操作</th>
    </tr>
<%
        for (GoodsItem item : items) {
%>
    <tr>
        <td><%= item.getName() %></td>
        <td>￥<%= item.getPrice() %></td>
        <td>
            <input type="number" name="quantity_<%= item.getId() %>" 
                   value="<%= item.getQuantity() %>" min="1" style="width: 50px;">
        </td>
        <td>￥<%= item.getPrice() * item.getQuantity() %></td>
        <td>
            <input type="submit" name="action" value="修改">
            <input type="hidden" name="id" value="<%= item.getId() %>">
            <a href="controller?action=delete&id=<%= item.getId() %>">删除</a>
        </td>
    </tr>
<%
        }
%>
</table>
<input type="submit" name="action" value="批量修改">
</form>
<p><strong>总计：￥<%= cart.getTotal() %></strong></p>
<%
    }
%>
<p><a href="index.html">继续购物</a></p>
</body>
</html>
```

#### ControllerServlet.java源代码：
```java
package com.servlet;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.*;
import com.cart.*;

@WebServlet("/controller")
public class ControllerServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        String action = request.getParameter("action");
        
        if ("delete".equals(action)) {
            // 处理删除商品请求
            deleteItem(request, response);
        } else if ("updateItem".equals(action)) {
            // 处理更新商品请求
            updateItem(request, response);
        } else {
            // 显示购物车
            showCart(request, response);
        }
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        String action = request.getParameter("action");
        
        if ("修改".equals(action) || "批量修改".equals(action)) {
            // 处理更新商品请求
            updateItem(request, response);
        } else {
            // 其他POST请求
            showCart(request, response);
        }
    }
    
    // 显示购物车
    private void showCart(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        request.getRequestDispatcher("showCart.jsp").forward(request, response);
    }
    
    // 删除商品
    private void deleteItem(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        HttpSession session = request.getSession();
        ShoppingCart cart = (ShoppingCart) session.getAttribute("cart");
        
        if (cart != null) {
            String idStr = request.getParameter("id");
            if (idStr != null && !idStr.isEmpty()) {
                int id = Integer.parseInt(idStr);
                cart.remove(id);
            }
        }
        
        showCart(request, response);
    }
    
    // 更新商品
    private void updateItem(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        HttpSession session = request.getSession();
        ShoppingCart cart = (ShoppingCart) session.getAttribute("cart");
        
        if (cart != null) {
            // 方式1：通过查询参数更新单个商品
            String idStr = request.getParameter("id");
            String quantityStr = request.getParameter("quantity_" + idStr);
            
            if (idStr != null && !idStr.isEmpty() && quantityStr != null && !quantityStr.isEmpty()) {
                int id = Integer.parseInt(idStr);
                int quantity = Integer.parseInt(quantityStr);
                
                // 创建临时商品对象用于更新
                GoodsItem item = new GoodsItem();
                item.setId(id);
                item.setQuantity(quantity);
                
                cart.update(item);
            } else {
                // 方式2：批量更新所有商品
                for (GoodsItem item : cart.getItems()) {
                    String qtyStr = request.getParameter("quantity_" + item.getId());
                    if (qtyStr != null && !qtyStr.isEmpty()) {
                        int quantity = Integer.parseInt(qtyStr);
                        item.setQuantity(quantity);
                    }
                }
            }
        }
        
        showCart(request, response);
    }
}
```

## 四、思考题

### 1. 如何理解会话失效与超时？如何通过程序设置最大失效时间？如何通过Web应用程序部署描述文件设置最大超时时间？二者有什么区别？

**答：** 
**会话失效与超时：**
- 会话失效是指会话对象被销毁，不能再用于跟踪用户状态
- 会话超时是指在指定时间内用户没有与服务器进行任何交互，会话自动失效

**通过程序设置最大失效时间：**
```java
// 设置会话超时时间为30分钟
session.setMaxInactiveInterval(30 * 60); // 单位为秒
```

**通过Web应用程序部署描述文件设置最大超时时间：**
```xml
<session-config>
    <session-timeout>30</session-timeout> <!-- 单位为分钟 -->
</session-config>
```

**二者区别：**
1. **作用范围**：程序设置只对当前会话有效，部署描述文件对整个Web应用的所有会话有效
2. **优先级**：程序设置的优先级高于部署描述文件
3. **灵活性**：程序设置可以在运行时动态调整，部署描述文件需要修改配置文件并重启应用

### 2. 能否通过客户机的IP地址实现会话跟踪？

**答：** 理论上可以通过客户机的IP地址实现会话跟踪，但这种方法存在以下问题：

**局限性：**
1. **NAT问题**：多个用户可能共享同一个公网IP地址（通过NAT）
2. **代理问题**：用户可能通过代理服务器访问，所有用户显示为同一个IP
3. **动态IP**：用户可能使用动态IP地址，IP地址会发生变化
4. **负载均衡**：在负载均衡环境中，同一用户的请求可能被分发到不同服务器

**不推荐的原因：**
1. **准确性差**：无法准确识别不同用户
2. **安全性低**：IP地址容易伪造
3. **扩展性差**：不适用于大规模应用

因此，通常不推荐仅通过IP地址实现会话跟踪，而应结合其他技术如Cookie、Session等。

### 3. 假如开发的Web应用程序是假设客户支持Cookie的，但应用程序部署后，你发现大多数客户禁用了Cookie，这对应用程序有何影响？如何修改它？

**答：** 
**影响：**
1. **会话跟踪失效**：基于Cookie的会话管理将无法正常工作
2. **用户状态丢失**：无法维持用户的登录状态和购物车等信息
3. **功能异常**：依赖会话的功能可能出现异常

**修改方案：**
1. **URL重写**：将会话ID附加到URL中
   ```java
   String encodedUrl = response.encodeURL("nextPage.jsp");
   ```

2. **隐藏表单域**：在表单中添加隐藏字段传递会话ID
   ```html
   <input type="hidden" name="jsessionid" value="<%= session.getId() %>">
   ```

3. **混合方案**：优先使用Cookie，如果检测到Cookie被禁用则使用URL重写
   ```java
   // 检查是否支持Cookie
   if (request.isRequestedSessionIdFromCookie()) {
       // 使用Cookie
   } else {
       // 使用URL重写
   }
   ```

4. **改进用户体验**：在应用首页检测Cookie支持情况，并提示用户启用Cookie以获得更好的体验