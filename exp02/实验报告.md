# 实验二  JSP技术及应用

## 班级                       学号                        姓名                   

---

## 一、实验目的
1. 熟练掌握JSP的声明、表达式、小脚本和注释的使用；
2. 理解JSP页面指令和动作的语法格式；
3. 理解JSP页面的生命周期；
4. 熟练掌握page指令的常用属性：import、session、errorPage、isErrorPage、contentType、pageEncoding；
5. 熟练掌握JSP的内置对象及用法；
6. 熟练掌握JSP作用域对象及用法。

## 二、实验要求
1. 实验前进行预习，完成实验预习报告；
2. 按照每一项实验内容进行上机实践与编程，将程序源代码和运行结果图附在实验报告中实验内容对应的部分。
3. 实验预习报告和实验报告打印装订在一起。
4. 将每一次实验的源代码按目录组织保存并压缩，按照老师指定的要求进行提交。代码保存方式如：exp02表示实验二Web项目的名称，其下保存各项实验内容的源文件及相关资源，将整个exp02文件夹进行压缩后命名为班级-姓名-实验2，如：计181-张三-实验2。

## 三、实验内容与步骤

### 1. 创建计数器页面

#### 代码实现
```jsp
<html><body>
<%@ page language="java" %>
<%! int count = 0; %>
<% count++; %>
Welcome! You are visitor number
<%= count %>
</body></html>
```

#### 步骤1：在浏览器中访问该页面
**结果分析：**
首次访问页面显示"Welcome! You are visitor number 1"，每次刷新页面计数器都会增加。这是因为`<! int count = 0; %>`声明了一个类级别的变量，所有用户共享同一个计数器。

#### 步骤2：打开counter.jsp转换后的源文件
**结果分析：**
Tomcat将JSP文件转换为Java Servlet源代码，通常位于`work/Catalina/localhost/exp02/org/apache/jsp/`目录下，文件名为`counter_jsp.java`。对应的类文件为`counter_jsp.class`。

#### 步骤3：count变量声明位置
**结果分析：**
count变量在转换后的Java类中作为实例变量声明，位于类的顶部。

#### 步骤4：修改为局部变量
**代码对比：**
```jsp
<%! int count = 0; %>  // 全局变量，所有用户共享
<% int count = 0; %>   // 局部变量，每次请求都初始化为0
```
**区别分析：**
使用局部变量时，每次页面刷新计数器都会显示1，因为每次请求都会重新初始化变量。

### 2. errorPage属性和isErrorPage属性的使用

#### 步骤1：创建hello.jsp页面
```jsp
<%@ page language="java" errorPage="errorHandler.jsp" contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"%>
<html>
<body>
<%
    String name = request.getParameter("name");
    if (name == null || name.equals("")) {
        throw new RuntimeException("没有指定name 属性");
    } else {
        out.println("Hello " + name);
    }
%>
</body>
</html>
```

#### 步骤2：创建errorHandler.jsp错误处理页面
```jsp
<%@ page language="java" isErrorPage="true" contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"%>
<html>
<body>
<h2>错误处理页面</h2>
<p>发生了以下错误：</p>
<p><%= exception.getMessage() %></p>
</body>
</html>
```

#### 步骤3：访问测试
**URL 1：http://localhost:8080/exp02/hello.jsp**
结果显示错误处理页面，提示"没有指定name 属性"。

**URL 2：http://localhost:8080/exp02/hello.jsp?name=欧阳清风**
结果显示"Hello 欧阳清风"。

**原因分析：**
当没有提供name参数时，程序抛出异常并跳转到errorHandler.jsp页面处理错误；当提供name参数时，正常显示欢迎信息。

**乱码问题解决：**
在初始测试中，错误处理页面显示中文乱码。这是由于没有正确设置页面编码导致的。通过在page指令中添加`contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"`属性，成功解决了中文乱码问题。

### 3. 应用session对象实现用户登录系统

#### 步骤1：创建login.jsp文件
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>用户登录</title>
</head>
<body>
<h2>用户登录</h2>
<%
    // 获取错误信息
    String errorMsg = (String) request.getAttribute("errorMsg");
    if (errorMsg != null) {
%>
    <p style="color:red;"><%= errorMsg %></p>
<%
    }
%>
<form action="deal.jsp" method="post">
    <table>
        <tr>
            <td>用户名：</td>
            <td><input type="text" name="username" value="<%= request.getParameter("username") != null ? request.getParameter("username") : "" %>"></td>
        </tr>
        <tr>
            <td>密码：</td>
            <td><input type="password" name="password"></td>
        </tr>
        <tr>
            <td colspan="2">
                <input type="submit" value="登录">
                <input type="reset" value="重置">
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <p><small>提示：可用账户 admin/123456, user1/password1, user2/password2</small></p>
            </td>
        </tr>
    </table>
</form>
</body>
</html>
```

#### 步骤2：编写deal.jsp文件
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%
    // 模拟用户数据库
    String[][] users = {
        {"admin", "123456"},
        {"user1", "password1"},
        {"user2", "password2"}
    };
    
    // 获取表单数据
    String username = request.getParameter("username");
    String password = request.getParameter("password");
    
    // 验证用户
    boolean isValidUser = false;
    for (int i = 0; i < users.length; i++) {
        if (users[i][0].equals(username) && users[i][1].equals(password)) {
            isValidUser = true;
            break;
        }
    }
    
    if (isValidUser) {
        // 登录成功，将用户名保存到session中
        session.setAttribute("username", username);
        // 重定向到主页面
        response.sendRedirect("main.jsp");
    } else {
        // 登录失败，设置错误信息并转发回登录页面
        request.setAttribute("errorMsg", "用户名或密码错误，请重新输入！");
        request.getRequestDispatcher("login.jsp").forward(request, response);
    }
%>
```

#### 步骤3：编写main.jsp文件
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.Date" %>
<%
    // 从session中获取用户名
    String username = (String) session.getAttribute("username");
    
    // 如果未登录，重定向到登录页面
    if (username == null) {
        response.sendRedirect("login.jsp");
        return;
    }
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>主页面</title>
</head>
<body>
<h2>欢迎,<%= username %>!</h2>
<p>当前时间:<%= new Date() %></p>
<a href="exit.jsp">退出登录</a>
</body>
</html>
```

#### 步骤4：编写exit.jsp文件
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%
    // 销毁session
    session.invalidate();
    // 重定向到登录页面
    response.sendRedirect("login.jsp");
%>
```

#### 问题分析与解决
在初始测试中，用户在登录页面输入用户名和密码后点击登录按钮，页面会清空输入并返回登录页面，没有任何提示。这是因为：

1. **错误处理机制不完善**：原代码在登录失败时使用`response.sendRedirect("login.jsp")`重定向回登录页面，这种方式会丢失所有请求参数和错误信息。

2. **缺少用户反馈**：没有向用户显示任何错误信息，用户不知道登录失败的原因。

**解决方案：**
1. 在`deal.jsp`中使用`request.getRequestDispatcher("login.jsp").forward(request, response)`请求转发代替重定向，这样可以保留请求中的属性信息。
2. 在`login.jsp`中添加错误信息显示功能，当登录失败时显示具体的错误原因。
3. 在登录表单中保留用户已输入的用户名，提升用户体验。
4. 添加可用账户提示信息，方便用户测试。

### 4. 通过application对象实现页面访问计数器功能

#### 代码实现
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%
    // 使用同步块确保线程安全
    synchronized (application) {
        // 从application对象中获取访问计数
        Integer accessCount = (Integer) application.getAttribute("accessCount");
        
        // 如果是第一次访问，初始化计数器
        if (accessCount == null) {
            accessCount = 0;
        }
        
        // 计数器加1
        accessCount++;
        
        // 将更新后的计数器保存到application对象中
        application.setAttribute("accessCount", accessCount);
    }
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>网站访问计数器</title>
</head>
<body>
<h2>网站访问计数器</h2>
<p>本网站已被访问 <%= application.getAttribute("accessCount") %> 次。</p>
</body>
</html>
```

### 5. 编写页面停留时间统计

#### 代码实现
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.Date" %>
<%
    // 获取登录时间
    Date loginTime = (Date) session.getAttribute("loginTime");
    
    // 如果是第一次访问，记录登录时间
    if (loginTime == null) {
        loginTime = new Date();
        session.setAttribute("loginTime", loginTime);
    }
    
    // 获取当前时间
    Date currentTime = new Date();
    
    // 计算停留时间（毫秒）
    long stayTime = currentTime.getTime() - loginTime.getTime();
    
    // 转换为秒
    long staySeconds = stayTime / 1000;
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="refresh" content="10">
<title>页面停留时间统计</title>
</head>
<body>
<h2>页面停留时间统计</h2>
<p>登录时间: <%= loginTime %></p>
<p>当前时间: <%= currentTime %></p>
<p>您已在本页面停留 <%= staySeconds %> 秒。</p>
<p>页面每10秒自动刷新一次。</p>
</body>
</html>
```

## 四、思考题

### 1. 如何给JSP页面设置初始化参数并访问这些初始化参数？
在web.xml中配置JSP页面的初始化参数：
```xml
<servlet>
    <servlet-name>counterJsp</servlet-name>
    <jsp-file>/counter.jsp</jsp-file>
    <init-param>
        <param-name>initialValue</param-name>
        <param-value>100</param-value>
    </init-param>
</servlet>
```

在JSP页面中访问初始化参数：
```jsp
<%
    String initialValue = config.getInitParameter("initialValue");
%>
```

### 2. JSP的四大作用域对象对应的Servlet类、作用及范围各是什么？

| 作用域对象 | 对应Servlet类 | 作用 | 范围 |
|-----------|--------------|------|------|
| pageContext | PageContext | 提供对页面属性的访问 | 当前页面 |
| request | HttpServletRequest | 提供对HTTP请求数据的访问 | 当前请求 |
| session | HttpSession | 提供对会话数据的访问 | 当前用户会话 |
| application | ServletContext | 提供对应用程序数据的访问 | 整个Web应用 |

## 五、实验总结

通过本次实验，我掌握了JSP的基本语法和核心概念，理解了JSP页面的生命周期，熟练使用了JSP的内置对象和作用域对象。实验中遇到的主要问题是如何正确使用session和application对象，以及如何处理JSP页面中的异常。通过实践，我加深了对Web开发中状态管理和数据共享机制的理解。

在实验过程中，我还遇到了中文乱码的问题，通过正确设置page指令的contentType和pageEncoding属性，成功解决了这一问题。这让我认识到在Web开发中字符编码设置的重要性。

此外，在实现用户登录系统时，我也遇到了一些问题，如登录失败后没有反馈信息、用户输入被清空等。通过使用请求转发代替重定向、添加错误信息显示和保留用户输入等方法，成功解决了这些问题，提升了用户体验。